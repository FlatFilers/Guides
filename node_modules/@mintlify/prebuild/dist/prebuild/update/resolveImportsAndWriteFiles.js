import { resolveAllImports, hasImports, findAndRemoveImports, getDecoratedNavPageAndSlug, topologicalSort, } from '@mintlify/common';
import { outputFile } from 'fs-extra';
import { join } from 'path';
export const resolveImportsAndWriteFiles = async (openApiFiles, pagesAcc, snippetsV2, filesWithImports) => {
    const snippetsWithResolvedImports = await resolveImportsInSnippets(snippetsV2);
    const writeSnippetsWithImportsPromises = await writeSnippets(snippetsWithResolvedImports);
    const pagesWithResolvedImports = await resolveImportsInPages(openApiFiles, snippetsWithResolvedImports, filesWithImports, pagesAcc);
    const writePagesPromise = writePages(pagesWithResolvedImports);
    await Promise.all([...writeSnippetsWithImportsPromises, ...writePagesPromise]);
};
const resolveImportsInSnippets = async (snippetsV2) => {
    const snippetsWithImportsPromises = snippetsV2.map(async (snippet) => ({
        ...(await findAndRemoveImports(snippet.content)),
        filename: snippet.filename,
    }));
    const snippetsWithImports = await Promise.all(snippetsWithImportsPromises);
    const graph = {};
    snippetsWithImports.forEach((snippetWithImports) => {
        graph[snippetWithImports.filename] = Object.keys(snippetWithImports.importMap);
    });
    const order = topologicalSort(graph).reverse();
    const orderedSnippetsWithImports = order
        .map((filename) => {
        return snippetsWithImports.find((snippet) => snippet.filename === filename);
    })
        .filter(Boolean);
    for (const snippetWithImports of orderedSnippetsWithImports) {
        if (hasImports(snippetWithImports)) {
            snippetWithImports.content = await resolveAllImports({
                snippets: orderedSnippetsWithImports,
                fileWithImports: snippetWithImports,
            });
        }
    }
    return snippetsWithImports;
};
const writeSnippets = async (snippetsWithImports) => snippetsWithImports.map(async (snippetWithImports) => {
    const targetPath = join('public', snippetWithImports.filename);
    await outputFile(targetPath, snippetWithImports.content, {
        flag: 'w',
    });
});
const resolveImportsInPages = async (openApiFiles, snippetsWithResolvedImports, filesWithImports, pagesAcc) => {
    const filesWithResolvedImportsPromises = filesWithImports.map(async (fileWithImports) => {
        const content = await resolveAllImports({
            snippets: snippetsWithResolvedImports,
            fileWithImports,
        });
        const { slug, pageMetadata } = getDecoratedNavPageAndSlug(fileWithImports.filename, content, openApiFiles);
        pagesAcc[slug] = pageMetadata;
        const targetPath = join('src', '_props', fileWithImports.filename);
        return {
            targetPath,
            content,
        };
    });
    return await Promise.all(filesWithResolvedImportsPromises);
};
const writePages = (filesWithResolvedImports) => filesWithResolvedImports.map(async ({ targetPath, content }) => {
    await outputFile(targetPath, content, {
        flag: 'w',
    });
});
